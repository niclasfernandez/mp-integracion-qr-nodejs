
<div class="stack as-search-wrapper" role="main">
    <div class="as-navtuck-wrapper">
        <div class="as-l-fullwidth  as-navtuck" data-events="event52">
            <div class="pd-billboard pd-category-header">
                <div class="pd-l-plate-scale">
                    <div class="pd-billboard-background">
                        <img src="/assets/music-audio-alp-201709" alt="" width="1440" height="320" data-scale-params-2="wid=2880&amp;hei=640&amp;fmt=jpeg&amp;qlt=95&amp;op_usm=0.5,0.5&amp;.v=1503948581306" class="pd-billboard-hero ir">
                    </div>
                    <div class="pd-billboard-info">
                        <h1 class="pd-billboard-header pd-util-compact-small-18">Loja e-commerce</h1>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div>
        <div style="height: 77px;">
            <h2>
                Smartphones
            </h2>
        </div>
        <div style="white-space: nowrap; overflow-x: auto; overflow-y: hidden;">
            <div style="display: inline-block">
                <img src="{{img}}" style="width: 400px;">
            </div>
            <div style="display: inline-block">
                <img src="{{qr_img}}" style="width: 400px;">
            </div>
            <div style="display: inline-block; white-space: nowrap; overflow-x: auto; overflow-y: hidden;">
                <div class="as-producttile-info col-4">
                    <h2>{{title}}</h2>
                    <h3>${{price}}</h3>
                    <h3>Unidades: {{unit}}</h3>
                    <button id="create_button" onclick="createOrder()" class="mercadopago-button-create">Generar Orden</button>
                    <button hidden id="cancel_button" onclick="cancelOrder()" class="mercadopago-button-cancel">Cancelar Orden</button>
                    <h3 id="order_status"></h3>
                    <input hidden id="external_reference_id"></input>
                </div>
            </div>  
        </div>
    </div>
</div>
<script>
    function getExternalReferenceId() {
        return document.getElementById('external_reference_id');
    }
    // Simple polling function to display any order status update.
    var pollInterval = undefined;
    var poll = function() {
        $.ajax({
            url: "{{baseurl}}/api/status?external_reference="+getExternalReferenceId().value,
            dataType: 'json',
            type: 'get',
            success: function(data) {
                if ( data.status ) {
                    document.getElementById('order_status').innerHTML = 'Estado de la orden: '+data.status;
                    if(data.status === 'closed') {
                        clearInterval(pollInterval);
                    }
                }
            },
            error: function (data) {
                console.log('Error:', data);
            }
        });
    };

    var orderData = {
        title: "{{title}}",
        unit_price: {{price}},
        quantity: {{unit}},
        picture_url: "{{img}}"
    }

    function createOrder() {
        $.ajax({
            url: "{{baseurl}}/api/order",
            type: 'post',
            contentType: 'application/json',
            dataType: 'json', 
            data: JSON.stringify(orderData),
            success: function(data) {
                if ( data.order.external_reference ) {
                    getExternalReferenceId().value = data.order.external_reference;
                    document.getElementById('create_button').setAttribute('hidden', false);
                    document.getElementById('cancel_button').removeAttribute('hidden');
                    pollInterval = setInterval( function() { poll(); }, 3000);
                    poll();
                }
            },
            error: function (data) {
                console.log('Error:', data);
            }
        });
    }

    function cancelOrder() {
        $.ajax({
            url: "{{baseurl}}/api/order",
            type: 'delete',
            success: function(data) {
                getExternalReferenceId().value = "";
                document.getElementById('cancel_button').setAttribute('hidden', false);
                document.getElementById('create_button').removeAttribute('hidden');
                document.getElementById('order_status').innerHTML = "";
                clearInterval(pollInterval);
            },
            error: function (data) {
                console.log('Error:', data);
            }
        });
    }
</script>